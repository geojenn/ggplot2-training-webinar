---
title: "GGPLOT2 Webinar"
author: "Shane Cone"
date: "3/13/2020"
output: html_document
---

```{r}
library(tidyverse)
library(lubridate)
dat <- read_csv("C2.1.1CONUSv16.0_2020_p_unit_level_activity_enhanced_v2-tg.csv")
dat_ozone <- read_csv("MLK 2017 AQS data Tidy.csv")

View(dat)
str(dat)
length(dat)

dat_ozone_long <- dat_ozone %>% 
  pivot_longer(-DateTime, names_to = "Measure", values_to = "Values")

dat_ozone_long_daily_summer <- dat_ozone_long %>%
  filter(Measure == "o3", DateTime >= as.Date('2017-05-01') & DateTime <= as.Date('2017-10-01')) %>% 
  group_by(Date = date(DateTime)) %>%
  summarize("Daily Avg" = mean(Values))

dat_long <- dat %>% 
  select(1:37) %>% 
pivot_longer(7:37, names_to = "Metric", values_to = "Values")

dat_long %>% 
  filter(State == "DE", Metric == "Maximum hourly heat input (mmbtu)") %>% 
  group_by(Facility) %>% 
  summarize("Sum of Heat Output" = sum(Values))

dat_long %>% 
  filter(Metric == "Maximum hourly heat input (mmbtu)") %>% 
ggplot(aes(x = State, y = Values)) +
  geom_col()


```


# Grammar of Graphics

Who here has been frustrated with making charts or graphs in Excel??
Simple charts, with small data, are quick and easy in Excel. But you quickly bump into the limits of what it can do for you. 

In contrast, the possibilities are quite literally endless in R! 

We will be discussing how to build visualizations in R using ggplot2. Ggplot2 builds charts using the grammar of graphics approach. 

The grammar of graphics provides a layered approach to building a chart. 

There are three main, necessary arguments to supply to gglpot in order to chart something. 

## Requireid layer 1 - Data

```{r} 
#Starting with the AQS data
ggplot(dat_ozone)
```

The first necessary item is the dataset you want to chart. In this instance, we will be starting with the AQS data that we used in the the open-air webinar.

Here, we passed the dataset("dat_ozone") as the first argument to ggplot. Also, remember, since the data is the first argument, we can also pipe the dataset into ggplot

```{r}
dat_ozone %>% 
  ggplot()
```

This provides the first requirement, but of course, doesn't actually build a chart yet. It's sort of like having data in a table in Excel - it's necessary, but insufficient!


## Required Layer 2 - Aesthetics

Next, you will define some aesthetic mappings to ggplot. 


```{r}

ggplot(dat_ozone, aes(x = DateTime, y = o3))
```


This looks like an empy plot, too, but what have we actually accomplished here?

In ggplot2 in R, you build a data visualization piece by piece.The first call just supplies the dataset, but provides no mapping. That is why you get an empty/gray square. However, once we have supplied "aes()", we have mapped our x and y variables. This then also provides the **scale** to ggplot, which is why our x and y axes have both a label, **and** a range! 

(this is a fine detail, but actually important. With one mapping - the call to aes() - we have provided multiple required layers!)

However, we don't have any data actually plotted yet! That is because we have not procided a "geom", or a geometric object to map onto the chart. 

## Required Layer 3 - Geometries!

The part of a chart that everyone is familir with is the geometry, or the "geom", in ggplot2-speak. This defines the "type" of chart, in the sense of bar charts vs. line charts vs. scatterplots, etc. 

We'll start with a scatterplot, whose associated geometry, or geom, is "geom_point"

```{r}
ggplot(dat_ozone, aes(x = DateTime, y = o3)) +
  geom_point()

```


Let's talk through this output. First to note - we recieved a warning symbol - the message being, "Removed 107 rows containing missing values (geom_point)". Remember in the "working with data" webinar, that R takes missing data *VERY* seriously. 

The sort of "catch-all" way to remove NA values from your commands is, "na.rm = TRUE". So, if we pass that to the geom call, we will get the same result, but without the warning.

```{r}
ggplot(dat_ozone, aes(x = DateTime, y = o3)) +
  geom_point(na.rm = TRUE)
```

So, we have a scatterplot geom that has been mapped onto the exact chart space we had before we called a geomgetry. Remember, our aes() call supplied the scale, and the geom just maps the geometric object onto the datapoints. But, this scatterplot isn't so great. The first issue is that each day has 24 points, and we're mapping an entire year. That's just too much data to make sense of in this way.

Let's take a look at how we might subset this data, and just look at the summer ozone season.

```{r, fig.width= 10, fig.height= 6}
dat_ozone %>% 
  filter(DateTime >= as.Date('2017-05-01') & DateTime <= as.Date('2017-10-01')) %>% 
  ggplot(aes(x = DateTime, y = o3)) +
  geom_point(na.rm = TRUE)

```


We are using more of the skills we learned in the "working with data" webinar! We piped the dataset to the filter "verb", and selected only the DateTimes after May 1 AND before Oct 1. 



## Adding multiple geoms!

```{r, fig.width= 10, fig.height= 6}
dat_ozone %>% 
  filter(DateTime >= as.Date('2017-05-01') & DateTime <= as.Date('2017-10-01')) %>% 
  ggplot(aes(x = DateTime, y = o3)) +
  geom_point(na.rm = TRUE) +
  geom_smooth(method = lm)

```

While a linear model line plotted on this dataset isn't actually that informative, it shows that you can build more complex R charts by adding geoms to your plot! In this case, there are two geoms - point and smooth.

## More on Aesthetics

I wanted to talk a little more about this "aesthetic" mapping, and how to do in in ggplot.

In all the above code, we defined the aes() call in the intial ggplot call. Like this:

```{r, include = TRUE}
ggplot(dat_ozone, aes(x = DateTime, y = o3)) +
  geom_point()
```

However, looks what happens when we move the aes() call, like this:

```{r, include = TRUE}
dat_ozone %>% 
ggplot() +
  geom_point(aes(x = DateTime, y = o3), na.rm = TRUE)
```


It looks exactly the same!
What's happening here?

When you call aes() in the ggplot() call, it will pass that aesthetic mapping to all geoms that you call later, unless you specifcy a different aes() in that geom. 

Some examples:

```{r}
dat_ozone %>% 
  filter(DateTime >= as.Date('2017-05-01') & DateTime <= as.Date('2017-10-01')) %>% 
  ggplot(aes(x = DateTime, y = o3)) +
  geom_point(na.rm = TRUE) +
  geom_smooth(method = lm)

#same as:
dat_ozone %>% 
  filter(DateTime >= as.Date('2017-05-01') & DateTime <= as.Date('2017-10-01')) %>% 
  ggplot() +
  geom_point(aes(x = DateTime, y = o3), na.rm = TRUE) +
  geom_smooth(aes(x = DateTime, y = o3), method = lm)


```


We see the two ways of calling aes() here, and both charts are exactly the same! 
So why would you want to call aes() in the geom, instead of in the ggplot call?

well, if you wanted to plot different things to different geoms!



```{r, fig.width= 10, fig.height= 6}
dat_ozone %>% 
  filter(DateTime >= as.Date('2017-05-01') & DateTime <= as.Date('2017-10-01')) %>% 
  ggplot(aes(x = DateTime, y = o3)) +
  geom_point(na.rm = TRUE) +
  geom_col(data = dat_ozone_long_daily_summer, aes(x = as.POSIXct(Date), y = `Daily Avg`))

```


Forget, for a moment, that this is an ugly chart, and focus, rather on what we accomplished. We were able to map two different gemoetries onto the same chart! 




## Facets

Another layet that can be added to a ggplot visualization is a facet. 

```{r}
dat_ozone_long %>% 
  filter(Measure == c("o3", "nox", "so2")) %>% 
  ggplot() +
  geom_point(aes(x = DateTime, y = Values)) +
  facet_wrap(~ Measure)

```











## Let's talk about labels

Chart labels, that is!
You should always label your charts, to make them easy to udnerstand for your audience. ggplot has numerous ways to add labels, but the easiest is probably with the "lab" call

```{r, fig.width= 10, fig.height= 6}
dat_ozone %>% 
  filter(DateTime >= as.Date('2017-05-01') & DateTime <= as.Date('2017-10-01')) %>% 
  ggplot(aes(x = DateTime, y = o3)) +
  geom_point(na.rm = TRUE) +
  labs(title = "Hourly Ozone Concentrations",
        x = "Date",
        y = "Ozone (ppb)")


```




